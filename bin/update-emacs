#!/usr/bin/env zsh
#
# Updates and rebases Spacemacs automatically

cd ~/.emacs.d/
[[ -z $(git diff) ]] || should_stash=true

[[ $should_stash = true ]] && git stash >/dev/null
old_revision=$(git rev-parse HEAD)
git pull --rebase
new_revision=$(git rev-parse HEAD)
[[ $should_stash = true ]] && ( \
  git stash pop >/dev/null || \
  (echo "Unstashing failed, you should manually fix ~/.emacs.d/."; exit 1))

if [[ $old_revision != $new_revision ]]; then
  make autoloads autoremove install update compile-core
else
  make update
fi

# Just in case the daemon is still running
kill $(emacsclient -en "(emacs-pid)" 2>/dev/null) 2>/dev/null
