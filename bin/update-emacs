#!/usr/bin/env bash
#
# Update and rebase Doom Emacs automatically.

set -e

# Make sure dotfiles are up to date first
cd ~/.dotfiles
git pull --rebase --autostash

cd ~/.emacs.d
git pull --rebase --autostash

bin/doom clean
bin/doom -y upgrade
bin/doom -y compile

# Restart Emacs in case the daemon is still running
if systemctl --user is-active emacs --quiet; then
  systemctl --user restart emacs
else
  kill "$(emacsclient -en "(emacs-pid)" 2>/dev/null)" 2>/dev/null || true
fi
