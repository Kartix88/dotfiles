#!/usr/bin/env python3
#
# Lists the length of every file in the current directory

from multiprocessing import Pool
import os
import sys

from pymediainfo import MediaInfo


def get_runtime(filename):
    tracks = MediaInfo.parse(filename).tracks
    if not tracks or tracks[0].duration is None:
        return None

    duration = int(tracks[0].duration / 1000)
    minutes, seconds = divmod(duration, 60)
    hours, minutes = divmod(minutes, 60)
    runtime = f"{seconds}s"
    if minutes > 0:
        runtime = f"{minutes}m " + runtime
    if hours > 0:
        runtime = f"{hours}h " + runtime

    return f"{filename} :: {runtime}"


if len(sys.argv) > 1:
    os.chdir(sys.argv[1])

with Pool(8) as p:
    files = [f for f in os.listdir() if os.path.isfile(f)]
    lengths = [s for s in p.imap_unordered(get_runtime, files) if s is not None]

    print("\n".join(sorted(lengths)))
