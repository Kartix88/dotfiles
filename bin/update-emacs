#!/usr/bin/env bash
#
# Updates and rebases Spacemacs automatically

# Make sure dotfiles are up to date first
cd ~/.dotfiles

old_revision=$(git rev-parse HEAD)
git pull --rebase --autostash
new_revision=$(git rev-parse HEAD)
[[ $old_revision != $new_revision ]] && should_update=true

cd ~/.emacs.d

old_revision=$(git rev-parse HEAD)
git pull --rebase --autostash
new_revision=$(git rev-parse HEAD)
[[ $old_revision != $new_revision ]] && should_update=true

# Byte compilation sometimes messes things up even after updating non-core
# dependencies so we'll just have to deal with byte compiling everything from
# scratch every time
bin/doom clean

if [[ $should_update ]]; then
  bin/doom -y refresh
fi

bin/doom -y update
bin/doom -y compile

# Restart Emacs in case the daemon is still running
if systemctl --user is-active emacs --quiet; then
  systemctl --user restart emacs
else
  kill "$(emacsclient -en "(emacs-pid)" 2>/dev/null)" 2>/dev/null || true
fi
