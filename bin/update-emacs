#!/usr/bin/env zsh
#
# Updates and rebases Spacemacs automatically

# Make sure dotfiles are up to date first
cd ~/.dotfiles
git pull --rebase --autostash

cd ~/.emacs.d

old_revision=$(git rev-parse HEAD)
git pull --rebase --autostash
new_revision=$(git rev-parse HEAD)

if [[ $old_revision != $new_revision ]]; then
  make clean autoloads autoremove install update compile-core
else
  make update
fi

# Restart Emacs in case the daemon is still running
if systemctl --user is-active emacs --quiet; then
  systemctl --user restart emacs
else
  kill $(emacsclient -en "(emacs-pid)" 2>/dev/null) 2>/dev/null || true
fi
